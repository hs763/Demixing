singularity shell --bind $PWD:/mnt luca_r_env.sif
cd /mnt

cd /cephfs2/hannas/demixing/data/reads

#human FASTQ file 
wget ftp://ftp.ebi.ac.uk/pub/databases/microarray/data/experiment/MTAB/E-MTAB-7552/KAN030_H9_6k_128d_S6_L008_R1_001.fastq.gz
wget ftp://ftp.ebi.ac.uk/pub/databases/microarray/data/experiment/MTAB/E-MTAB-7552/KAN030_H9_6k_128d_S6_L008_R2_001.fastq.gz
wget ftp://ftp.ebi.ac.uk/pub/databases/microarray/data/experiment/MTAB/E-MTAB-7552/KAN030_H9_6k_128d_S6_L008_I1_001.fastq.gz
wget https://www.ebi.ac.uk/biostudies/arrayexpress/studies/E-MTAB-7552/sdrf

#chimp FASTQ file 
wget ftp://ftp.ebi.ac.uk/pub/databases/microarray/data/experiment/MTAB/E-MTAB-7552/KAN027_Sandra_6k_120d_1_S3_L005_R1_001.fastq.gz 
wget ftp://ftp.ebi.ac.uk/pub/databases/microarray/data/experiment/MTAB/E-MTAB-7552/KAN027_Sandra_6k_120d_1_S3_L005_R2_001.fastq.gz 
wget ftp://ftp.ebi.ac.uk/pub/databases/microarray/data/experiment/MTAB/E-MTAB-7552/KAN027_Sandra_6k_120d_1_S3_L005_I1_001.fastq.gz 
wget https://www.ebi.ac.uk/biostudies/arrayexpress/studies/E-MTAB-7552/sdrf

gunzip KAN030_H9_6k_128d_S6_L008_R1_001.fastq.gz H9_128d_org1.fastq
gunzip KAN030_H9_6k_128d_S6_L008_R2_001.fastq.gz 
gunzip KAN030_H9_6k_128d_S6_L008_I1_001.fastq.gz

#getting genomes from ENSEMBLE
#for .fa use primary assembly ot top-level files
# chimp .fa and .gtf respectively 
wget https://ftp.ensembl.org/pub/release-110/fasta/pan_troglodytes/dna/Pan_troglodytes.Pan_tro_3.0.dna.toplevel.fa.gz
wget https://ftp.ensembl.org/pub/release-110/gtf/pan_troglodytes/Pan_troglodytes.Pan_tro_3.0.110.gtf.gz

#makign reference genome
#from Ensembl database wget the FASTQ files with primary_assembly/yoplevel and GFT file
#filter only portein coding genes to prevent mutiple mapping. 
cellranger mkgtf \
  Homo_sapiens.GRCh38.110.gtf \
  Homo_sapiens.GRCh38.110.filtered.gtf \
  --attribute=gene_biotype:protein_coding

cellranger mkgtf \
  Pan_troglodytes.Pan_tro_3.0.110.gtf \
  Pan_troglodytes.Pan_tro_3.0.110.filtered.gtf \
  --attribute=gene_biotype:protein_coding

#making mixed reference genome
cellranger mkref --genome=GRCh38 --fasta=Homo_sapiens.GRCh38.dna.primary_assembly.fa --genes=Homo_sapiens.GRCh38.110.filtered.gtf \
                 --genome=Pan_tro_3 --fasta=Pan_troglodytes.Pan_tro_3.0.dna.toplevel.fa --genes=Pan_troglodytes.Pan_tro_3.0.110.filtered.gtf


#aligning human and chimp FASTQ agaisn mixed genome 
nohup cellranger count \
    --id=human_mixed_ref \
    --fastqs=/cephfs2/hannas/demixing/data/reads/H9_6k_128d_fastqs \
    --transcriptome=/cephfs2/hannas/demixing/data/genome/GRCh38_and_Pan_tro_3

nohup cellranger count \
    --id=chimp_mixed_ref \
    --fastqs=/cephfs2/hannas/demixing/data/reads/Sandra_6k_120d_fastqs \
    --transcriptome=/cephfs2/hannas/demixing/data/genome/GRCh38_and_Pan_tro_3

#reading matricies into r
library(Matrix)
matrix_dir = "/opt/human_mixed_ref/outs/filtered_feature_bc_matrix/"
barcode.path <- paste0(matrix_dir, "barcodes.tsv.gz")
features.path <- paste0(matrix_dir, "features.tsv.gz")
matrix.path <- paste0(matrix_dir, "matrix.mtx.gz")
mat <- readMM(file = matrix.path)
feature.names = read.delim(features.path,
                           header = FALSE,
                           stringsAsFactors = FALSE)
barcode.names = read.delim(barcode.path,
                           header = FALSE,
                           stringsAsFactors = FALSE)
colnames(mat) = barcode.names$V1
rownames(mat) = feature.names$V1

